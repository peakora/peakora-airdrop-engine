name: Generate .env.example

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *' # every 6 hours

permissions:
  contents: write

jobs:
  gen-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create .env from secrets (temporary, not committed)
        shell: bash
        run: |
          cat > .env <<'EOF'
          RPC_URLS=${{ secrets.REAL_RPC_URLS }}
          CHAIN_ID=${{ secrets.REAL_CHAIN_ID }}
          CHROME_PATH=${{ secrets.REAL_CHROME_PATH }}
          CHROME_PROFILE_PATH=${{ secrets.REAL_CHROME_PROFILE_PATH }}
          PRIMARY_ADDRESS=${{ secrets.REAL_PRIMARY_ADDRESS }}
          PRIVATE_KEY_PRIMARY=${{ secrets.REAL_PRIVATE_KEY_PRIMARY }}
          PRIVATE_KEY_NODE=${{ secrets.REAL_PRIVATE_KEY_NODE }}
          DISTRIBUTION_ADDRESSES=${{ secrets.REAL_DISTRIBUTION_ADDRESSES }}
          ONEINCH_API=${{ secrets.REAL_ONEINCH_API }}
          DISTRIBUTION_THRESHOLD_ETH=${{ secrets.REAL_DISTRIBUTION_THRESHOLD_ETH }}
          DISTRIBUTION_AMOUNT_ETH=${{ secrets.REAL_DISTRIBUTION_AMOUNT_ETH }}
          POLL_INTERVAL_MS=${{ secrets.REAL_POLL_INTERVAL_MS }}
          LOG_LEVEL=${{ secrets.REAL_LOG_LEVEL }}
          EOF

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Detect package manager and install dependencies
        shell: bash
        run: |
          set -e
          if [ -f pnpm-lock.yaml ]; then
            echo "pnpm lockfile detected. Enabling corepack and running pnpm ci"
            corepack enable
            corepack prepare pnpm@latest --activate
            pnpm -v
            pnpm ci
          elif [ -f yarn.lock ]; then
            echo "yarn.lock detected. Installing dependencies with yarn"
            npm install -g yarn
            yarn install --frozen-lockfile
          else
            echo "No pnpm/yarn lockfile detected. Using npm ci"
            npm ci
          fi

      - name: Run generator
        run: node scripts/generate-env-example.js

      - name: Verify .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo ".env.example not found; aborting commit step"
            exit 1
          fi

      - name: Commit and push .env.example
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .env.example
          git commit -m "chore: regenerate .env.example" || echo "no changes to commit"
          git push origin HEAD:main || echo "push failed or no changes"

      - name: Cleanup temporary .env
        if: always()
        run: |
          # remove temporary .env created from secrets
          rm -f .env || true
